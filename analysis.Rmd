---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
```


```{r}
cancer_data_all_scotland <- read_csv("data/raw_data/cancer_data_all_Scot.csv") %>% 
  janitor::clean_names()
cancer_data_by_HB <- read_csv("data/raw_data/cancer_data_by_HB.csv") %>% 
  janitor::clean_names()
HB_lookup_tibble <- read_csv("data/raw_data/geo_HB_labels_lookup.csv") %>% 
  janitor::clean_names()
```

```{r}
borders_hb_code <- HB_lookup_tibble %>% 
  filter(hb_name == "NHS Borders") %>% 
  select(hb) %>% 
  pull()
```


```{r}
cancer_data_by_HB %>%
  filter(hb == borders_hb_code) %>%
  filter(cancer_site == "All cancer types") %>% 
  filter(sex == "All") %>% 
  ggplot() +
  aes(x = year) +
  geom_line(
    aes(y = crude_rate), size = 2
  ) +
  geom_ribbon(
    aes(ymin = crude_rate_lower95pc_confidence_interval,
        ymax = crude_rate_upper95pc_confidence_interval), fill = "grey", alpha = 0.5
  ) +
    geom_line(
    aes(y = easr), colour = "blue"
  ) +
  geom_ribbon(
    aes(ymin = easr_lower95pc_confidence_interval,
        ymax = easr_upper95pc_confidence_interval), fill = "light blue", alpha = 0.2
  ) +
    geom_line(
    aes(y = wasr), colour = "green"
  ) +
  geom_ribbon(
    aes(ymin = wasr_lower95pc_confidence_interval,
        ymax = wasr_upper95pc_confidence_interval), fill = "light green", alpha = 0.2
  ) +
  theme_bw()
```
```{r}
cancer_data_tidy <- cancer_data_by_HB %>% 
  select(-cancer_site_icd10code) %>%
  mutate(group = row_number()) %>% 
  rename(sir = standardised_incidence_ratio) %>% 
  pivot_longer(cols = -c(hb:incidences_all_ages,
                       easr_lower95pc_confidence_interval_qf,
                       easr_upper95pc_confidence_interval_qf,
                       wasr_lower95pc_confidence_interval_qf,
                       wasr_upper95pc_confidence_interval_qf,
                       group),
               names_pattern = "([^_]*)([_a-z0-9$]*)",
               names_to = c("measurement", "limit")) %>%
  mutate(limit = recode(limit, "_rate" = "")) %>% 
  mutate(limit = case_when(
    str_detect(limit, "lower") ~ "lower_95pc_c_i",
    str_detect(limit, "upper") ~ "upper_95pc_c_i",
    limit == "" ~ "value",
    TRUE ~ limit)
  ) %>% 
  pivot_wider(id_cols = -c(limit,value), names_from = limit,
              values_from = value, names_repair = "check_unique") %>% 
  mutate(measurement = str_to_upper(measurement)) %>% 
  filter(incidences_all_ages > 20) %>% 
  select(-easr_lower95pc_confidence_interval_qf,
         -easr_upper95pc_confidence_interval_qf,
         -wasr_lower95pc_confidence_interval_qf,
         -wasr_upper95pc_confidence_interval_qf,
         -sex_qf) %>% 
  filter(cancer_site == "All cancer types") %>% 
  filter(sex == "All") %>% 
  filter(hb == "S08000015")
```

```{r}
cancer_data_crude <- cancer_data_long %>% 
  filter(measurement == "CRUDE")

cancer_data_easr <- cancer_data_long %>% 
  filter(measurement == "EASR")

cancer_data_wasr <- cancer_data_long %>% 
  filter(measurement == "WASR") %>% 
  filter(year == "1994")

cancer_data_sir <- cancer_data_long %>% 
  filter(measurement == "SIR")
```

```{r}
init_plot <-
  ggplot() +
  aes(x = year)

make_line_plot <- function (data, plot) {
  p <- plot +
  geom_line(data = data,
            aes(y = value)) +
  geom_ribbon(data = data,
              aes(ymin = lower_95pc_c_i,
                  ymax = upper_95pc_c_i), alpha = 0.2)
  return(p)
}

crude_plot <- make_line_plot(cancer_data_crude, init_plot)

crude_plot

```

```{r}
make_line_plot(cancer_data_easr, crude_plot)
```

```{r}
make_line_plot(cancer_data_wasr)
```

```{r}
make_line_plot(cancer_data_sir)
```

```{r}
```


```{r}
cancer_data_by_HB %>%
  filter(hb == borders_hb_code) %>%
  filter(cancer_site == "All cancer types") %>% 
  filter(sex == "Female") %>% 
  ggplot() +
  aes(x = year) +
  geom_line(
    aes(y = standardised_incidence_ratio), colour = "red"
  ) +
  geom_ribbon(
    aes(ymin = sir_lower95pc_confidence_interval,
        ymax = sir_upper95pc_confidence_interval), fill = "coral", alpha = 0.2
  ) +
  theme_bw()
```

```{r}
hb_shapes <- readOGR(
  dsn ="data/shapefiles/SG_NHS_HealthBoards_2019/",
  layer = "SG_NHS_HealthBoards_2019",
  GDAL1_integer64_policy = TRUE)

crs <- CRS("+proj=longlat +datum=WGS84")

# transform shape data to plot on map
hb_shapes_ll <- hb_shapes %>% 
  rgeos::gSimplify(tol=25, topologyPreserve=TRUE) %>% 
  spTransform(crs)

hb_shapes@polygons <- hb_shapes_ll@polygons
```



cancer_site = body location of cancer
crude_rate = total number of events / population

european age-standardised rate
world age-standardised rate


Confidence intervals for age-standardised rates (EASR and WASR) have been
calculated using a formula which works only when numbers are sufficiently large.
They are therefore set to 'not applicable' in the event of there being fewer
than 20 cases.



In comparing cancer incidence between areas or over time, three important
factors must be considered—the number of people at risk, their sex and their
age.

Since the risk of developing cancer doubles with every eight or nine years of
life, an area with an older population would be expected, all else being equal,
to have more incident cancer cases than an area with a younger population. There
are several different approaches available to adjust for differences in age;
this atlas has used indirect standardization, which is the most appropriate
method for small area comparisons, as it provides more stable rates than other
standardization techniques, and works even if there is no population-at-risk in
some age groups within the area (Estève et al., 1994).

For each small area i, the national incidence rates for each age group j were
applied to the population counts (N) in each age group, to calculate the total
expected number of cancers (E) in the area. This can be compared to the number
actually observed (O) in the area, in the form of an observed to expected ratio,
or percentage. This is called the standardised incidence ratio, abbreviated to
SIR. The SIR for any cancer for either men or women is,
by definition, 1 (or 100%).


A Standardized Incidence Ratio (SIR) is used to determine if the occurrence of
cancer in a relatively small population is high or low. An SIR analysis can tell
us if the number of observed cancer cases in a particular geographic area is
higher or lower than expected, given the population and age distribution for
that community.

The SIR is obtained by dividing the observed number of cases of cancer by the
“expected” number of cases. The expected number is the number of cases that
would occur in a community if the disease rate in a larger reference population
(usually the state or country) occurred in that community. Since cancer rates
increase strongly with age, the SIR takes into account whether a community’s
population is older or younger than the reference population.

