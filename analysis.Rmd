---
title: "NHS Borders | Cancer Incidence Rates"
output:
  html_document:
    df_print: paged
---

```{r, eval = TRUE, echo = FALSE, message = FALSE}
# load in the tidyverse
library(tidyverse)
```

```{r, eval = TRUE, echo = FALSE, message = FALSE}
# read in cancer incidence data
cancer_data_by_HB <- read_csv("data/clean_data/cancer_data_by_HB_clean.csv")
# read in lookup tibble
HB_lookup_tibble <- read_csv("data/raw_data/geo_HB_labels_lookup.csv") %>% 
  janitor::clean_names()
```
## 1. Introduction and Aims

### Brief
In order to help inform the planning for provision of cancer treatment services
in NHS Borders, we would like to gain better understanding of the incidence of
cancer in NHS Borders.

### Investigation Aims

The aims of this investigation are to answer the following questions: 

1. What is the trend in cancer incidence over the period?
2. What types of cancer are the most common?
3. What types of cancer have the highest increase in incidence rate over the
period?
4. Which types of cancer are most prevalent among men?
5. Which types of cancer are most prevalent among women?

## 2. Analysis
```{r, eval = TRUE, echo = FALSE}
# get area code for NHS Borders from lookup tibble
borders_hb_code <- HB_lookup_tibble %>% 
  filter(hb_name == "NHS Borders") %>% 
  select(hb) %>% 
  pull()

# filter cancer data for only NHS Borders Health Board
cancer_data_borders <- cancer_data_by_HB %>%
  filter(hb == borders_hb_code)
```

```{r, eval = TRUE, echo = FALSE}
# get names of specific cancer sites (ignore "All")
specific_cancers <- cancer_data_borders %>%
  distinct(cancer_site) %>% 
  filter(!str_detect(cancer_site, "All")) %>% 
  pull()
```

```{r, eval = TRUE, echo = FALSE}
# create function that filters the data and calculates the sum of all cancer
# incidences for each cancer site
generate_sum_incidences_per_cancer_site <-
  function(data, sex = "All", year = 1994) {
  data %>% 
  filter(cancer_site %in% specific_cancers) %>% 
  filter(measurement == "CRUDE") %>% 
  filter(sex == sex) %>% 
  filter(year >= year) %>% 
  group_by(cancer_site) %>% 
  summarise(total_incidences = sum(incidences_all_ages), .groups = "drop_last")
  }
```

```{r, eval = TRUE, echo = FALSE}
sum_incidences_per_cancer_site <- generate_sum_incidences_per_cancer_site(
  cancer_data_borders
)
```

### 1. What is the trend in cancer incidence over the period?

The overview looks only at all cancer types. First looking at the combination of
all sexes

```{r, eval = TRUE, echo = FALSE}
cancer_data_borders %>% 
  filter(cancer_site == "All cancer types") %>% 
  filter(sex == "All") %>% 
  ggplot() +
  aes(
    x = year,
    y = incidences_all_ages
  ) +
  geom_line() +
  facet_wrap(~sex) +
  theme_bw()
```

And then at each sex separately:

```{r, eval = TRUE, echo = FALSE}
cancer_data_borders %>% 
  filter(cancer_site == "All cancer types") %>% 
  filter(sex != "All") %>% 
  ggplot() +
  aes(
    x = year,
    y = incidences_all_ages
  ) +
  geom_line() +
  facet_wrap(~sex) +
  theme_bw()
```


### 2. What types of cancer are the most common?

```{r, eval = TRUE, echo = FALSE}
sum_incidences_per_cancer_site %>% 
  arrange(desc(total_incidences)) %>% 
  rename(`Cancer Site` = cancer_site,
         `Total Incidences` = total_incidences)
```

```{r, eval = TRUE, echo = FALSE}
make_bar_plot <- function(data) {
  data %>% 
    ggplot() + 
    aes(x = cancer_site,
        y = total_incidences) +
    geom_col() +
    theme_bw() + 
    theme(axis.text.y = element_text(angle = 0, hjust = 1)) +
    coord_flip()
}
```

```{r, eval = TRUE, echo = FALSE}
sum_incidences_per_cancer_site %>% 
  make_bar_plot()
```
```{r, eval = TRUE, echo = FALSE}
sum_incidences_per_cancer_site %>% 
  slice_max(total_incidences, n = 10) %>% 
  make_bar_plot()
```

```{r, eval = TRUE, echo = FALSE}
sum_incidences_per_cancer_site_recent <- generate_sum_incidences_per_cancer_site(
  cancer_data_borders,
  year = 2009
)
```

```{r, eval = TRUE, echo = FALSE}
sum_incidences_per_cancer_site_recent %>% 
  make_bar_plot()
```

```{r, eval = TRUE, echo = FALSE}
sum_incidences_per_cancer_site_recent %>% 
  slice_max(total_incidences, n = 10) %>% 
  make_bar_plot()
```

3. What types of cancer have the highest increase in incidence rate over the
period?

Examination of crude rates:

```{r, eval = TRUE, echo = FALSE}
cancer_data_borders %>% 
  filter(cancer_site %in% specific_cancers) %>% 
  filter(sex == "Female") %>% 
  filter(measurement == "CRUDE") %>%
  group_by(cancer_site) %>% 
  summarise(year, diff_crude_rate = value - lag(value),
            .groups = "drop_last") %>% 
  group_by(cancer_site) %>% 
  summarise(mean_diff = mean(diff_crude_rate, na.rm = TRUE),
            .groups = "drop_last") %>% 
  slice_max(mean_diff, n = 10) %>%
  ggplot() +
  aes(x = cancer_site,
      y = mean_diff) + 
  geom_col() +
  coord_flip() +
  theme_bw() +
  labs(title = "Mean increase in crude rate | Male") +
  theme(plot.title = element_text(hjust = 0.5))
  
```

```{r, eval = TRUE, echo = FALSE}
cancer_data_borders %>% 
  filter(cancer_site %in% specific_cancers) %>% 
  filter(sex == "Male") %>% 
  filter(measurement == "CRUDE") %>%
  group_by(cancer_site) %>% 
  summarise(year, diff_crude_rate = value - lag(value),
            .groups = "drop_last") %>% 
  group_by(cancer_site) %>% 
  summarise(mean_diff = mean(diff_crude_rate, na.rm = TRUE),
            .groups = "drop_last") %>% 
  slice_max(mean_diff, n = 10) %>%
  ggplot() +
  aes(x = cancer_site,
      y = mean_diff) + 
  geom_col() +
  coord_flip() +
  theme_bw() +
  labs(title = "Mean increase in crude rate | Male") +
  theme(plot.title = element_text(hjust = 0.5))
```


### 4. Which types of cancer are most prevalent among men?

```{r, eval = TRUE, echo = FALSE}
highest_cancers_2018_male <- cancer_data_borders %>% 
  filter(cancer_site %in% specific_cancers) %>% 
  filter(measurement == "CRUDE") %>% 
  filter(sex == "Male") %>% 
  filter(year == "2018") %>% 
  group_by(cancer_site) %>% 
  summarise(mean_c_rate = mean(value, na.rm = TRUE), .groups = "drop_last") %>% 
  slice_max(mean_c_rate, n = 5) %>% 
  select(cancer_site) %>% 
  pull()
```


```{r, eval = TRUE, echo = FALSE}
cancer_data_borders %>% 
  filter(cancer_site %in% specific_cancers) %>% 
  filter(cancer_site %in% highest_cancers_2018_male) %>% 
  filter(measurement == "CRUDE") %>% 
  filter(sex == "Male") %>%
  group_by(cancer_site) %>%
  ggplot() +
  aes(x = year, y = value, group = cancer_site, colour = cancer_site) +
  geom_line() +
  labs(x = "Year",
       y = "Crude Rate",
       title = "A title you need to change later") +
  facet_wrap(~cancer_site) +
  theme_bw() +
  theme(legend.position = "none")
```

5. Which types of cancer are most prevalent among women?

```{r, eval = TRUE, echo = FALSE}
highest_cancers_2018_female <- cancer_data_borders %>% 
  filter(cancer_site %in% specific_cancers) %>% 
  filter(measurement == "CRUDE") %>% 
  filter(sex == "Female") %>% 
  filter(year == "2018") %>% 
  group_by(cancer_site) %>% 
  summarise(mean_c_rate = mean(value, na.rm = TRUE), .groups = "drop_last") %>% 
  slice_max(mean_c_rate, n = 5) %>% 
  select(cancer_site) %>% 
  pull()
```


```{r, eval = TRUE, echo = FALSE}
cancer_data_borders %>% 
  filter(cancer_site %in% specific_cancers) %>% 
  filter(cancer_site %in% highest_cancers_2018_female) %>% 
  filter(measurement == "CRUDE") %>% 
  filter(sex == "Female") %>%
  group_by(cancer_site) %>%
  ggplot() +
  aes(x = year, y = value, group = cancer_site, colour = cancer_site) +
  geom_line() +
  facet_wrap(~cancer_site) +
  theme_bw() +
  theme(legend.position = "none")
```

## Results and Conclusion



cancer_site = body location of cancer
crude_rate = total number of events / population

european age-standardised rate
world age-standardised rate


Confidence intervals for age-standardised rates (EASR and WASR) have been
calculated using a formula which works only when numbers are sufficiently large.
They are therefore set to 'not applicable' in the event of there being fewer
than 20 cases.



In comparing cancer incidence between areas or over time, three important
factors must be considered—the number of people at risk, their sex and their
age.

Since the risk of developing cancer doubles with every eight or nine years of
life, an area with an older population would be expected, all else being equal,
to have more incident cancer cases than an area with a younger population. There
are several different approaches available to adjust for differences in age;
this atlas has used indirect standardization, which is the most appropriate
method for small area comparisons, as it provides more stable rates than other
standardization techniques, and works even if there is no population-at-risk in
some age groups within the area (Estève et al., 1994).

For each small area i, the national incidence rates for each age group j were
applied to the population counts (N) in each age group, to calculate the total
expected number of cancers (E) in the area. This can be compared to the number
actually observed (O) in the area, in the form of an observed to expected ratio,
or percentage. This is called the standardised incidence ratio, abbreviated to
SIR. The SIR for any cancer for either men or women is,
by definition, 1 (or 100%).


A Standardized Incidence Ratio (SIR) is used to determine if the occurrence of
cancer in a relatively small population is high or low. An SIR analysis can tell
us if the number of observed cancer cases in a particular geographic area is
higher or lower than expected, given the population and age distribution for
that community.

The SIR is obtained by dividing the observed number of cases of cancer by the
“expected” number of cases. The expected number is the number of cases that
would occur in a community if the disease rate in a larger reference population
(usually the state or country) occurred in that community. Since cancer rates
increase strongly with age, the SIR takes into account whether a community’s
population is older or younger than the reference population.

